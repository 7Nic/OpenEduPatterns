<!DOCTYPE html>
<html>
<head>
    <% include partials/head.ejs %>
    <script type="text/javascript" src="../ckeditor5/ckeditor.js"></script>
</head>
<body>
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <a href="/"><img src="../img/logoedu4.png"></a>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mynavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <!-- Menu do navbar -->
            <div class="collapse navbar-collapse" id="mynavbar">
                <!-- Barra de pesquisa -->
                <form class="navbar-form navbar-right" method="POST" role="search" action="/generalsearch">
                    <div class="input-group">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="text" class="form-control" name="keyword" placeholder="Pesquisar">
                        <span class="input-group-btn">
                            <button type="submit" class="btn btn-default">
                            <span class="glyphicon glyphicon-search"></span>
                            </button>
                        </span>
                    </div>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/">Página inicial</a></li>
                    <li><a href="/languages">Linguagens</a></li>
                    <li class="active"><a href="/patterns">Padrões</a></li>
                    <li><a href="/about">Sobre</a></li>
                    <% if (loggedIn) { %>
                        <li>
                          <a class="nav-item nav-link dropdown-toggle mr-md-2" href="#" id="bd-versions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="button">
                            <i class="fa fa-user" aria-hidden="true"></i>
                                Usuário
                            <span class="caret"></span>
                          </a>

                          <!-- Dropdown menu -->
                          <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-versions">
                            <li><a href="/users/profile">Perfil</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="/users/logout">Sair</a></li>
                          </ul>
                          <!-- End dropdown menu -->

                        </li>
                    <% } else { %>
                        <li><a href="/users/login"><span class="glyphicon glyphicon-lock"></span>Entrar</a></li>
                    <% } %>
                </ul>

            </div>
        </div>
    </nav>  

    <div class="container criarNovoPadrao">
    	<h1>Criação de Novo Padrão</h1>
      <br>
      <h4>Observações:</h4>
      <p id="explanation">1 - Para melhor utilização do usuário, é disponibilizada a dinamicidade da criação do Padrão. Basta clicar em <strong>Adicionar campo aqui</strong> e o usuário poderá criar um novo padrão, que será salvo para posterior uso. Caso o novo elemento do template seja o de <strong>Padrões relacionados</strong>, basta clicar no botão verde <strong>Relacionar padrões</strong>.</p>
      <p id="explanation">2 - Ao inserir um link coloque o endereço completo: <strong>http://meulink.com</strong></p>
        <!-- Handle error -->
          <% if (templateElements.length === 0) { %>
            <p>Você reiniciou a página. Por favor volte à página anterior e escolha novamente seu template.</p>
            <a href="/patterns/chosetemplate" class="btn btn-info">Clique aqui</a>
          <% } %>

        <!-- Display errors -->
        <% if (messages.length > 0) { %>
            <div class="alert alert-danger">
                <% messages.forEach((message) => { %>
                <p><%= message %></p>
                <% }); %>
            </div>
        <% } %>
        <!-- End display errors -->

    	<form method="POST" action="" onsubmit="checkEmptyName(); verifyNewTemplate();">
    	   <% if (templateElements.length > 0) { %>
              <div class="form-group">
        	    <label for="visibilidade">Visibilidade</label>
        	    <select class="form-control" id="visibilidade"  name="visibilidade">
        	      <option>Público</option>
        	      <option>Privado</option>
        	    </select>
        	  </div>
          <% }; %>
          
          <!-- Loop -->
          <% templateElements.forEach((element, index) => { %>
          <div class="form-group">
              <% if (element.name === "Padrões relacionados" || element.name === "Padrões Relacionados" || element.name === "Padroes relacionados" || element.name === "Padroes Relacionados" || element.name === "padrões relacionados" || element.name === "padrões Relacionados" || element.name === "padroes relacionados" || element.name === "padroes Relacionados") { %>
                <label>Padrões relacionados</label>
                <input class="form-control" type="hidden" name="elementName[]" value="Padrões relacionados">
                <input class="form-control" type="hidden" id="elementContent[]" name="elementContent[]" value="This content is not a text, it's a relathionship in MySQL, therefore it can't be displayed here.">
              <% patterns.forEach((pattern) => { %>
                  <p><input type='checkbox' name='relatedPatterns' value='<%= pattern.padroes_id %>' > <%- pattern.titulo %></p>
              <% }) %>

            <% } else { %>
                <label><%= element.name %></label>
                <input class="form-control" type="hidden" name="elementName[]" value="<%= element.name %>">
                <textarea class="form-control ckeditor" id="elementContent[]" name="elementContent[]" rows="4" placeholder="Digite aqui o conteúdo deste elemento"></textarea>
            <% } %>

            </div>
            <a class="btn btn-info" onclick="addElement(this)">Adicionar campo aqui</a>
            <br>
            <br>
          <% }); %>
          <!-- End Loop -->

          <datalist id="commonNames">
                        <option>Nome</option>
                        <option>Classificação</option>
                        <option>Contexto</option>
                        <option>Motivação</option>
                        <option>Figura</option>
                        <option>Descrição</option>
                        <option>Problema</option>
                        <option>Solução</option>
                        <option>Alias</option>
                        <option>Diagrama da solução</option>
                        <option>Forças</option>
                        <option>Consequências</option>
                        <option>Usos conhecidos</option>
                        <option>Padrões relacionados</option>
                        <option>Contexto resultante</option>
                        <option>Justificativa</option>
                        <option>Rationale</option>
                    </datalist>

          <% if (templateElements.length > 0) { %>
              <input type="hidden" name="createNewTemplate" id="createNewTemplate" value="">
        	  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-success">Criar Padrão</button>
        	  <a class="btn btn-danger" href="/patterns">Cancelar</a>   
          <% }; %>
		</form>

    </div>

    <br>
    <br>
    <br>
    <footer class="text-center">
        <%- include partials/footer.ejs %>
    </footer>
    <!-- SCRIPTS -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!-- Dynamic form -->
    <script type="text/javascript">
        var counter = 0;

        function addElement(obj) {
            if (counter === 0) {
                var inputForTemplate = "<h3>Nome do novo Template</h3>"+
                                       "<input type='text' name='newTemplateName' class='form-control' placeholder='Digite aqui o nome de seu novo Template'>"+
                                       "<br>";

                $("#explanation").after(inputForTemplate);
            }
            counter += 1;
            var theHTML = "<a class='btn btn-info element"+counter+"Button' onclick='addElement(this); createCKEDITOR();'>Adicionar campo aqui</a>"+
                          "<div class='element"+counter+"Div newElement' id='element"+counter+"'>"+
                          "<br>"+
                          "<br>"+
                          "<a id='element"+counter+"' class='btn btn-danger btn-xs' onclick='removeElement(this)'>Remover</a>"+
                          "<a id='element"+counter+"' class='btn btn-success btn-xs' onclick='relatePatterns(this)'>Relacionar Padrões</a>"+
                          "<br>"+
                          "<br>"+
                          "<div class='form-group'>"+
                          "<input class='form-control' type='text' name='elementName[]' list='commonNames' placeholder='Digite o nome do elemento'>"+
                          "<br>"+
                          "<textarea class='form-control ckeditor' id='elementContent[]' name='elementContent[]' rows=4 placeholder='Digite aqui o conteúdo deste elemento'></textarea>"+
                          "</div>"+
                          "</div>";

            obj.insertAdjacentHTML('beforebegin', theHTML);


            textareaObj = document.querySelector( '.element'+counter+'Div textarea' );
          
            ClassicEditor
            .create(textareaObj, {
              removePlugins: [ 'MediaEmbed', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload' ],
            })
            .catch( error => {
              console.error( error );
            });
        }

        function removeElement(obj) {
            var elementToRemove = obj.id;   
            $("."+elementToRemove+"Button").remove();
            $("."+elementToRemove+"Div").remove();
        }

        // If the user didn't add an element, no template will be created 
        function verifyNewTemplate() {
            var qttNewElements = $("form .newElement").length;
            if (qttNewElements === 0) {
                $("#createNewTemplate").attr('value', false);
            } else {
                $("#createNewTemplate").attr('value', true);
            }
            console.log(qttNewElements);
            // alert('qqr coisa2');
        }

        function relatePatterns(obj) {
            var theHTML = "<br>"+
                          "<br>"+
                          "<a id='"+obj.id+"' class='btn btn-danger btn-xs' onclick='removeElement(this)'>Remover</a>"+
                          "<br>"+
                          "<br>"+
                          "<div class='form-group'>"+
                            "<label>Padrões relacionados</label>"+
                            "<input class='form-control' type='hidden' name='elementName[]' value='Padrões relacionados'>"+
                            "<% patterns.forEach((pattern) => { %>"+
                                "<p><input type='checkbox' name='relatedPatterns' value='<%= pattern.padroes_id %>' > <%- pattern.titulo %></p>"+
                            "<% }) %>"+
                          "</div>";                        
            $("."+obj.id+"Div").html(theHTML);
        }

        window.onload = function() {
          var editorsArray = document.querySelectorAll( '.ckeditor' );

          editorsArray.forEach(eachEditor => {
            ClassicEditor
            .create(eachEditor, {
              removePlugins: [ 'MediaEmbed', 'Image', 'ImageCaption', 'ImageStyle', 'ImageToolbar', 'ImageUpload' ],
            })
            .catch( error => {
              console.error( error );
            });
          });

          //Print the names of all plugins on the console
          // ClassicEditor.builtinPlugins.map( plugin => console.log(plugin.pluginName));
        }

        function checkEmptyName() {
          // var str = $("#elementContent[1] p").text();
          // alert(str);
          alert('bora');
          
          // var values = $("textarea[name='elementContent[]']")
          //     .map(function(){return $(this).text();}).get();

          var arr = $('input[name="pname[]"]').map(function () {
            return this.value; // $(this).val()
          }).get();

          console.log(arr);
          alert(arr[1]);

        }
    </script>
</body>
</html>
